# Sage Loop

**14-phase 자율 에이전트 오케스트레이션 시스템** - 조선시대 의정부 심의 체계에서 영감

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              SAGE LOOP v5                                   │
│                                                                             │
│   "검토하라"          "시행하라"           "완료 확인"                        │
│       ↓                   ↓                    ↓                            │
│   ┌──────┐            ┌──────┐             ┌──────┐                         │
│   │ SAGE │ ──────────→│ SAGE │ ───────────→│ SAGE │                         │
│   │  #1  │            │  #2  │             │  #3  │                         │
│   └──────┘            └──────┘             └──────┘                         │
│       │                   ↑                    ↑                            │
│       ▼                   │                    │                            │
│   ┌───────────────────────┼────────────────────┼───────────────────────┐    │
│   │           14-Phase Deliberation Chain                              │    │
│   └────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Quick Start

```bash
# 원클릭 설치
curl -fsSL https://raw.githubusercontent.com/seunghyuoffice-design/sage-loop/main/install.sh | bash

# 실행
/sage "API 인증 시스템 구현"
```

---

## 전체 플로우 다이어그램

```
Phase 1                     Phase 2-4 (6조 병렬)                    Phase 5
┌──────────┐     ┌─────────────────────────────────────────────┐   ┌──────────┐
│  SAGE    │     │  ┌────────┐ ┌────────┐ ┌────────┐           │   │ 도승지   │
│ "검토하라"│────→│  │이조 낭청│ │호조 낭청│ │예조 낭청│ (x6 병렬)  │──→│ 취합     │
│          │     │  └────────┘ └────────┘ └────────┘           │   └──────────┘
└──────────┘     │       ↓          ↓          ↓               │        │
                 │  ┌────────┐ ┌────────┐ ┌────────┐           │        ▼
                 │  │이조 판서│ │호조 판서│ │예조 판서│           │   Phase 6 (삼사 병렬)
                 │  └────────┘ └────────┘ └────────┘           │   ┌─────────────────┐
                 │       ↓          ↓          ↓               │   │┌─────┐┌─────┐┌─────┐│
                 │  ┌────────┐ ┌────────┐ ┌────────┐           │   ││사간원││사헌부││홍문관││
                 │  │이조 승지│ │호조 승지│ │예조 승지│           │   │└─────┘└─────┘└─────┘│
                 │  └────────┘ └────────┘ └────────┘           │   └─────────────────┘
                 └─────────────────────────────────────────────┘        │
                                                                        ▼
Phase 7          Phase 8 (양정 병렬)     Phase 9            Phase 10-11 (실행)
┌──────────┐     ┌─────────────────┐     ┌──────────┐     ┌─────────────────────┐
│ 도화서   │────→│ ┌─────┐ ┌─────┐ │────→│  SAGE    │────→│ ┌────────┐ (x6 병렬) │
│ 설계     │     │ │좌의정│ │우의정│ │     │ "시행하라"│     │ │집행관   │ → 도승지  │
└──────────┘     │ └─────┘ └─────┘ │     └──────────┘     │ └────────┘          │
                 └─────────────────┘                       └─────────────────────┘
                                                                   │
                                                                   ▼
Phase 12 (감찰 병렬)              Phase 13              Phase 14 (후속 병렬)
┌──────────────────────┐         ┌──────────┐         ┌──────────────────────────┐
│ ┌────────┐ ┌────────┐ │────────→│  SAGE    │────────→│ ┌──────┐ ┌──────┐ ┌──────┐ │
│ │암행어사│ │교서관  │ │         │"완료 확인"│         │ │춘추관│ │승문원│ │규장각│ │
│ └────────┘ └────────┘ │         └──────────┘         │ └──────┘ └──────┘ └──────┘ │
└──────────────────────┘                               └──────────────────────────┘
```

---

## 14 Phases 상세

### Phase 1: 접수 (Sage)

```
┌─────────────────────────────────────────────────────────────┐
│ 영의정 (Sage)                                               │
├─────────────────────────────────────────────────────────────┤
│ 역할: 청원 접수 및 심의 개시                                 │
│ 출력: "검토하라" + 분석 지시                                 │
│ 모델: opus + ultrathink                                     │
└─────────────────────────────────────────────────────────────┘
```

### Phase 2-4: 6조 병렬 처리

```
┌───────────────────────────────────────────────────────────────────────────┐
│                         6조 (Six Ministries)                              │
├───────────┬───────────┬───────────┬───────────┬───────────┬───────────────┤
│   이조    │   호조    │   예조    │   병조    │   형조    │    공조       │
│  (ijo)    │  (hojo)   │  (yejo)   │ (byeongjo)│(hyeongjo) │  (gongjo)     │
├───────────┼───────────┼───────────┼───────────┼───────────┼───────────────┤
│ 인사/역할 │ 재정/자원 │ 예법/문서 │ 운영/보안 │ 규정/감사 │ 인프라/빌드   │
├───────────┴───────────┴───────────┴───────────┴───────────┴───────────────┤
│                                                                           │
│  Phase 2: 낭청 (ideator-*)  → 아이디어 생성 (haiku)                       │
│  Phase 3: 판서 (analyst-*)  → 분석/필터링 (haiku)                         │
│  Phase 4: 승지 (seungji-*)  → 상신 형식화 (haiku)                         │
│                                                                           │
│  ※ 6개 역할이 동시 병렬 실행                                              │
└───────────────────────────────────────────────────────────────────────────┘
```

### Phase 5: 도승지 취합

```
┌─────────────────────────────────────────────────────────────┐
│ 도승지 (doseungji)                                          │
├─────────────────────────────────────────────────────────────┤
│ 역할: 6조 결과 취합 → 삼사 배포                              │
│ 입력: 6개 승지 상신문                                        │
│ 출력: 통합 보고서                                            │
└─────────────────────────────────────────────────────────────┘
```

### Phase 6: 삼사 병렬 검토

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        삼사 (Three Offices)                             │
├─────────────────────┬─────────────────────┬─────────────────────────────┤
│      사간원         │      사헌부         │        홍문관               │
│    (sagawon)        │    (saheonbu)       │     (hongmungwan)           │
├─────────────────────┼─────────────────────┼─────────────────────────────┤
│ 간쟁/비판           │ 규칙 감찰           │ 학술 자문                   │
│ 위험 지적           │ RULES 위반 봉쇄     │ 근거/선례 제공              │
├─────────────────────┼─────────────────────┼─────────────────────────────┤
│ 출력: 간쟁 목록     │ 출력: PASS/BLOCK    │ 출력: 학술 의견             │
├─────────────────────┴─────────────────────┴─────────────────────────────┤
│ 독설 (Dokseol):                                                         │
│ • "이건 비판이 아니라 아첨이다" (사간원)                                 │
│ • "규칙을 피해가려는 꼼수가 보인다" (사헌부)                             │
│ • "근거 없는 주장은 학문이 아니다" (홍문관)                              │
└─────────────────────────────────────────────────────────────────────────┘
```

### Phase 7-8: 설계 및 정승 심의

```
Phase 7                              Phase 8
┌─────────────────────┐              ┌─────────────────────────────────┐
│ 도화서 (dohwaseo)   │              │        양정 (Two Councilors)    │
├─────────────────────┤              ├────────────────┬────────────────┤
│ 역할: 구조 설계     │      ───→    │    좌의정      │    우의정      │
│ 입력: 삼사 검토본   │              │  (jwauijeong)  │  (uuijeong)    │
│ 출력: 설계 문서     │              ├────────────────┼────────────────┤
└─────────────────────┘              │ 내정 검토      │ 실무 검토      │
                                     │ (이조/호조/예조)│ (병조/형조/공조)│
                                     └────────────────┴────────────────┘
```

### Phase 9: 허가 (Sage)

```
┌─────────────────────────────────────────────────────────────┐
│ 영의정 (Sage) - 2차 등장                                    │
├─────────────────────────────────────────────────────────────┤
│ 역할: 실행 허가                                              │
│ 출력: "시행하라" + 실행 지침                                 │
│ 조건: 삼사 PASS + 양정 승인                                  │
└─────────────────────────────────────────────────────────────┘
```

### Phase 10-11: 실행

```
Phase 10 (6조 병렬)                         Phase 11
┌─────────────────────────────────┐         ┌─────────────────┐
│ 6조 집행관 (executor-*)         │         │ 도승지          │
├─────────────────────────────────┤   ───→  ├─────────────────┤
│ 이조 집행관: 인사 실행          │         │ 실행 결과 취합  │
│ 호조 집행관: 자원 할당          │         └─────────────────┘
│ 예조 집행관: 문서 작성          │
│ 병조 집행관: 배포/운영          │
│ 형조 집행관: 검증 실행          │
│ 공조 집행관: 빌드/인프라        │
│                                 │
│ 모델: sonnet (코드 실행)        │
└─────────────────────────────────┘
```

### Phase 12: 감찰

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      감찰 (Inspection)                                  │
├───────────────────────────────────┬─────────────────────────────────────┤
│         암행어사 (amhaeng)        │         교서관 (gyoseogwan)         │
├───────────────────────────────────┼─────────────────────────────────────┤
│ 역할: 실행 결과 비밀 감찰         │ 역할: 출력물 품질/스키마 검증       │
│ 출력: 부작용/오류/누락 목록       │ 출력: PASS/FAIL                     │
├───────────────────────────────────┼─────────────────────────────────────┤
│ 독설: "보이지 않는 곳에서         │ 독설: "형식만 갖추면 내용은         │
│       문제가 숨어있다"            │       어떻든 괜찮다고?"             │
└───────────────────────────────────┴─────────────────────────────────────┘
```

### Phase 13: 결재 (Sage)

```
┌─────────────────────────────────────────────────────────────┐
│ 영의정 (Sage) - 3차 등장 (최종)                             │
├─────────────────────────────────────────────────────────────┤
│ 역할: 최종 결재                                              │
│ 출력: "완료 확인" + EXIT_SIGNAL                             │
│ 조건: 감찰 PASS                                              │
│                                                             │
│ ※ 역사적으로 영의정이 3번 등장하는 의정부 체계 재현         │
└─────────────────────────────────────────────────────────────┘
```

### Phase 14: 기록 및 개선

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      후속 처리 (Post-processing)                        │
├─────────────────────┬─────────────────────┬─────────────────────────────┤
│      춘추관         │      승문원         │        규장각               │
│   (chunchugwan)     │   (seungmunwon)     │     (gyujanggak)            │
├─────────────────────┼─────────────────────┼─────────────────────────────┤
│ 역할: 이력 기록     │ 역할: 세션 회고     │ 역할: 개선안 도출           │
│ 출력: 변경 로그     │ 출력: 패턴 분석     │ 출력: 규칙/스킬 제안        │
└─────────────────────┴─────────────────────┴─────────────────────────────┘
```

---

## Chain Types

```
┌─────────────────────────────────────────────────────────────────────────┐
│ FULL (14 Phases)                                                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│ Sage → [6조 낭청] → [6조 판서] → [6조 승지] → 도승지                    │
│     → [삼사] → 도화서 → [좌의정 ∥ 우의정] → Sage                        │
│     → [6조 집행관] → 도승지 → [암행어사 ∥ 교서관] → Sage                │
│     → [춘추관 ∥ 승문원 ∥ 규장각]                                        │
├─────────────────────────────────────────────────────────────────────────┤
│ QUICK (5 Phases) - 빠른 실행                                            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                         │
│ 사간원 → 도화서 → Executor → [암행어사 ∥ 교서관] → 춘추관               │
├─────────────────────────────────────────────────────────────────────────┤
│ REVIEW (2 Phases) - 리뷰 전용                                           │
│ ━━━━━━━━━━━━━━━━━━                                                      │
│ [사간원 ∥ 교서관]                                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ DESIGN (4 Phases) - 설계 전용                                           │
│ ━━━━━━━━━━━━━━━━━━━━━━━━                                                │
│ Ideator → Analyst → 사간원 → 도화서                                     │
├─────────────────────────────────────────────────────────────────────────┤
│ RESEARCH (4 Phases) - 연구 전용                                         │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                            │
│ [Ideator ∥ 홍문관] → Analyst → 사간원                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Installation

### 원클릭 설치

```bash
curl -fsSL https://raw.githubusercontent.com/seunghyuoffice-design/sage-loop/main/install.sh | bash
```

### 6 Platforms

```
┌─────────────┬─────────────────────────────────────────────────────────┐
│ Platform    │ Command                                                 │
├─────────────┼─────────────────────────────────────────────────────────┤
│ Claude Code │ curl ... | bash -s claude                               │
│ OpenAI Codex│ curl ... | bash -s codex                                │
│ Antigravity │ curl ... | bash -s antigravity                          │
│ OpenCode    │ curl ... | bash -s opencode                             │
│ Cursor      │ curl ... | bash -s cursor                               │
│ VS Code     │ curl ... | bash -s vscode                               │
└─────────────┴─────────────────────────────────────────────────────────┘
```

### Git Clone

```bash
git clone https://github.com/seunghyuoffice-design/sage-loop.git
cd sage-loop
make install        # Claude Code (기본)
# make install-codex  # OpenAI Codex
```

---

## Usage

### Claude Code

```bash
# 기본 실행
/sage "사용자 인증 시스템 구현"

# 체인 지정
/sage --chain quick "로그인 버그 수정"
/sage --chain design "API 설계"
/sage --chain research "성능 최적화 방안 조사"
```

### CLI

```bash
# 새 체인 시작
python orchestrator.py "기능 X 구현"

# 역할 완료
python orchestrator.py --complete critic --result "pass"

# 상태 확인
python orchestrator.py --status

# 리셋
python orchestrator.py --reset
```

### 실행 예시

```
$ /sage "API 인증 구현"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 1: Sage (영의정)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
"검토하라. API 인증 시스템 구현 청원을 접수하였다."

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 2: 6조 낭청 (병렬 실행 중...)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[이조] JWT vs Session 인증 방식 제안
[호조] 토큰 스토리지 비용 분석
[예조] API 문서 형식 제안
[병조] 보안 정책 초안
[형조] OWASP 컴플라이언스 체크리스트
[공조] Redis 세션 스토어 인프라 제안

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 6: 삼사 (병렬 검토 중...)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[사간원] ⚠️ JWT 만료 처리 로직 누락 지적
[사헌부] ✓ PASS - 라이선스 위반 없음
[홍문관] 📚 RFC 7519 JWT 표준 인용

...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 13: Sage (영의정) - 최종 결재
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
"완료 확인. API 인증 시스템 구현을 승인한다."

EXIT_SIGNAL: APPROVED
```

---

## Model Mapping

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          Model Configuration                             │
├────────────────────┬─────────────────────┬───────────────────────────────┤
│ Role Type          │ Claude Code         │ OpenAI Codex                  │
├────────────────────┼─────────────────────┼───────────────────────────────┤
│ Supervision        │ opus + ultrathink   │ gpt-5.2 + reasoning:high      │
│ (sage, 삼사)       │                     │                               │
├────────────────────┼─────────────────────┼───────────────────────────────┤
│ Implementation     │ sonnet              │ gpt-5.2-codex                 │
│ (executor, 도화서) │                     │                               │
├────────────────────┼─────────────────────┼───────────────────────────────┤
│ Generation         │ haiku               │ gpt-5.1-codex-mini            │
│ (낭청, 판서, 승지) │                     │                               │
└────────────────────┴─────────────────────┴───────────────────────────────┘
```

---

## Architecture

```
sage-loop/
├── skills/                    # 역할 정의 (플랫폼 무관)
│   ├── yeong-ui-jeong/        # 오케스트레이터 (영의정)
│   │   ├── SKILL.md           # L2 스킬 정의
│   │   ├── reference.md       # 상세 가이드
│   │   └── scripts/           # L3 스크립트
│   │       ├── agenda_parser.py
│   │       ├── task_planner.py
│   │       └── lint_scripts.py
│   ├── sagawon.md             # 사간원
│   ├── saheonbu.md            # 사헌부
│   ├── hongmungwan.md         # 홍문관
│   └── ...
├── overlays/                  # 플랫폼별 설정
│   ├── claude/
│   ├── codex/
│   ├── antigravity/
│   ├── cursor/
│   ├── opencode/
│   └── vscode/
├── hooks/                     # Claude Code 훅
├── src/sage_loop/
│   ├── engine/                # 코어 오케스트레이션
│   ├── cli/                   # CLI 도구
│   └── schemas.py             # 데이터 모델
└── pyproject.toml
```

---

## Key Features

| Feature | Description |
|---------|-------------|
| 6조 병렬 실행 | 6개 부처가 동시에 처리 (Phase 2-4, 10) |
| 삼사 병렬 검토 | 사간원+사헌부+홍문관 동시 검토 (Phase 6) |
| 독설 (Dokseol) | 역할별 품질 강제 메시지 |
| 3회 Sage 등장 | 의정부 체계 재현 (접수/허가/결재) |
| 6 Platform | Claude, Codex, Antigravity, Cursor, OpenCode, VSCode |
| 오버레이 시스템 | 플랫폼별 모델/설정 분리 |
| Thread-safe | fcntl.flock + atomic writes |
| 순환 방지 | Circuit breaker 내장 |

---

## Historical Inspiration

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    조선 의정부 체계 (1392-1897)                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         ┌─────────┐                                     │
│                         │ 영의정  │ ← Chief State Councilor             │
│                         └────┬────┘                                     │
│                    ┌─────────┼─────────┐                                │
│                    ▼         ▼         ▼                                │
│              ┌─────────┐         ┌─────────┐                            │
│              │ 좌의정  │         │ 우의정  │                            │
│              │ (내정)  │         │ (외정)  │                            │
│              └─────────┘         └─────────┘                            │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                         육조 (Six Ministries)                    │   │
│  ├────────┬────────┬────────┬────────┬────────┬─────────────────────┤   │
│  │  이조  │  호조  │  예조  │  병조  │  형조  │  공조               │   │
│  │ 인사   │ 재정   │ 예법   │ 군사   │ 형법   │ 공업               │   │
│  └────────┴────────┴────────┴────────┴────────┴─────────────────────┘   │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                         삼사 (Three Offices)                     │   │
│  ├─────────────────────┬─────────────────────┬──────────────────────┤   │
│  │       사간원        │       사헌부        │       홍문관         │   │
│  │   (간쟁/비판)       │   (규칙/감찰)       │   (학술/자문)        │   │
│  └─────────────────────┴─────────────────────┴──────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## License

MIT License

## Contributing

Contributions welcome! Please read our contributing guidelines.
